# WASM Calculator

A web-based calculator application that uses **WebAssembly (WASM)** for computation. Rust handles all mathematical operations, compiled to WASM and executed in the browser. The frontend is pure HTML/CSS/JavaScript, served by Python's built-in HTTP server.

## Tech Stack

- **Backend Math**: Rust → WebAssembly (wasm-pack)
- **Frontend**: HTML5, CSS3, vanilla JavaScript (ES6 modules)
- **Build Tool**: wasm-pack 0.13.1
- **Server**: Python 3.12 (http.server with MIME type override)
- **Public Tunnel**: Cloudflare Tunnel (./cloudflared binary)
- **Runtime Requirements**: Node v24+, Python 3.12+, Rust 1.93.1+

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        User Browser                         │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  index.html + style.css                              │  │
│  │  ┌──────────────────────────────────────────────┐   │  │
│  │  │  index.js (ES6 Module)                      │   │  │
│  │  │  - Imports 8 functions from calculator.js   │   │  │
│  │  │  - Manages UI state & button clicks         │   │  │
│  │  │  - Calls WASM functions with user inputs    │   │  │
│  │  │  - Formats & displays results               │   │  │
│  │  └──────────────────────────────────────────────┘   │  │
│  │  ┌──────────────────────────────────────────────┐   │  │
│  │  │  calculator.js (generated by wasm-pack)    │   │  │
│  │  │  - WebAssembly glue code                    │   │  │
│  │  │  - Re-exports 8 Rust functions as JS      │   │  │
│  │  └──────────────────────────────────────────────┘   │  │
│  │  ┌──────────────────────────────────────────────┐   │  │
│  │  │  calculator_bg.wasm (3.5 KB)               │   │  │
│  │  │  - Compiled Rust bytecode                  │   │  │
│  │  │  - add, subtract, multiply, divide, etc.   │   │  │
│  │  └──────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↑
                      HTTP GET/POST
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
   Local Dev              Public via Cloudflare
   (Port 8000)            Tunnel (.cloudflared)
        │                                       │
   ┌────▼─────────────────┐        ┌──────────▼──────────┐
   │  Python http.server  │        │  Cloudflare Tunnel  │
   │  (localhost:8000)    │        │  → https://...      │
   │  - Serves www/       │        │    (no login)       │
   │  - MIME fix for .wasm│        │                     │
   └────────────────────┘         └─────────────────────┘
```

## Prerequisites

Before you begin, ensure you have these installed:

- **Node.js**: v24+ (check: `node --version`)
- **Python**: 3.12+ (check: `python --version`)
- **Rust**: 1.93.1+ (check: `rustc --version`)
- **wasm-pack**: 0.13.1+ (check: `wasm-pack --version`)
- **wasm32 target**: Rust target for WebAssembly

If you're missing any of the above, follow **Step 0: Install Tooling** below.

## Step 0: Install Tooling

### Install Rust & wasm-pack

Run these commands to set up the Rust toolchain and WebAssembly compilation tools:

```bash
# Install Rust (if not already installed)
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source "$HOME/.cargo/env"

# Verify Rust installation
rustc --version
cargo --version

# Add WebAssembly target
rustup target add wasm32-unknown-unknown

# Install wasm-pack
curl https://rustwasm.org/wasm-pack/installer/init.sh -sSf | sh

# Verify wasm-pack
wasm-pack --version
```

### Verify all tools

```bash
node --version      # Should be v24.x.x
python --version    # Should be 3.12.x
rustc --version     # Should be 1.93.1+
wasm-pack --version # Should be 0.13.1+
```

## Directory Structure

```
g-wasm-exp/
├── README.md                    # This file
├── CLAUDE.md                    # Claude Code project guidance
├── build.sh                     # Build script: compiles Rust → WASM
├── main.py                      # Dev server: Python http.server on port 8000
├── pyproject.toml               # Python project config (uv package manager)
├── cloudflared                  # Cloudflare Tunnel binary (for public URL)
├── ref.png                      # UI reference screenshot
│
├── calculator/                  # Rust crate (WASM source)
│   ├── Cargo.toml               # Rust dependencies & config
│   ├── src/
│   │   └── lib.rs               # 8 calculator functions with #[wasm_bindgen]
│   └── target/                  # (Rust build artifacts, excluded by .gitignore)
│
├── www/                         # Frontend served by Python server
│   ├── index.html               # Main calculator UI
│   ├── style.css                # Styling (24px rounded card, blue buttons)
│   ├── index.js                 # JS logic: imports WASM, handles clicks/inputs
│   ├── pkg/                     # (WASM output directory, excluded by .gitignore)
│   │   ├── calculator.js        # JS glue code (auto-generated by wasm-pack)
│   │   ├── calculator_bg.wasm   # Compiled WASM binary (3.5 KB)
│   │   ├── calculator.d.ts      # TypeScript definitions
│   │   ├── calculator_bg.wasm.d.ts
│   │   ├── package.json         # npm metadata for WASM module
│   │   └── .gitignore           # Excludes the entire pkg/ folder
│   └── pkg/                     # ← Built by build.sh; directory excluded from git
│
└── .gitignore                   # Excludes: __pycache__, /calculator/target/, /www/pkg/
```

## Step 1: Build the WASM Module

The `build.sh` script compiles your Rust code to WebAssembly:

```bash
bash build.sh
```

**What it does:**
1. Sources your Rust environment from `~/.cargo/env`
2. Runs: `wasm-pack build calculator --target web --out-dir ../www/pkg --release`
   - Compiles `calculator/src/lib.rs` to WebAssembly
   - Generates JavaScript glue code (`calculator.js`)
   - Outputs binary to `www/pkg/calculator_bg.wasm` (~3.5 KB)
   - Generates TypeScript declarations for IDE support
3. Prints: `Build complete. Run: python main.py`

**Output files** (regenerated each build):
- `www/pkg/calculator.js` (~4.8 KB) — JavaScript exports of all 8 functions
- `www/pkg/calculator_bg.wasm` (~3.5 KB) — Compiled Rust bytecode
- `www/pkg/calculator.d.ts` — TypeScript type hints

**When to rebuild:**
- After any change to `calculator/src/lib.rs`
- After adding dependencies to `calculator/Cargo.toml`
- Simply run `bash build.sh` again; old files are automatically replaced

## Step 2: Start the Dev Server

After building, start the Python HTTP server:

```bash
python main.py
```

**Output:**
```
Server running at http://localhost:8000/
Press Ctrl+C to stop
```

Open your browser and navigate to **http://localhost:8000/** — the calculator UI will load.

**Server details:**
- **Port**: 8000
- **Root directory**: `www/` (changed by `os.chdir()` in main.py)
- **MIME type fix**: The server sets `Handler.extensions_map[".wasm"] = "application/wasm"` so browsers accept the WASM binary
  - Without this, browsers may reject the `.wasm` file as incorrect content type
- **Static files served**: `index.html`, `style.css`, `index.js`, and everything in `www/pkg/`

## Step 3: Public URL via Cloudflare Tunnel

To share your calculator with others or access it remotely:

```bash
./cloudflared tunnel --url http://localhost:8000
```

**Output:**
```
...
Your Tunnel is available at: https://something-123456.trycloudflare.com
...
```

**Key points:**
- The tunnel is **no login required** — instant public URL
- Cloudflare proxies traffic from the public URL → your localhost:8000
- Works even if you're behind NAT or firewall
- URL is ephemeral; restart `cloudflared` to get a new URL
- The binary `./cloudflared` is already in your project root (v2026.2.0 FIPS)

**To make it persistent:**
- Consider logging in: `./cloudflared login` and creating a named tunnel
- Free tier: ephemeral tunnels last ~24 hours

---

## File Reference

| File | Type | Purpose |
|------|------|---------|
| `calculator/src/lib.rs` | Rust | 8 mathematical functions exported to WASM via `#[wasm_bindgen]` |
| `calculator/Cargo.toml` | Config | Rust dependencies (wasm-bindgen, wasm-bindgen-futures) |
| `www/index.html` | HTML | Calculator UI: 2 number inputs, 8 operation buttons, result display |
| `www/style.css` | CSS | Styling: card layout (480px), blue buttons (#5ba8e0), responsive design |
| `www/index.js` | JavaScript | Initializes WASM, wires up button clicks, formats results |
| `www/pkg/calculator.js` | Generated JS | Glue code exporting 8 Rust functions to JavaScript |
| `www/pkg/calculator_bg.wasm` | Generated WASM | Compiled Rust bytecode (3.5 KB) |
| `build.sh` | Bash | Build script: runs `wasm-pack build ...` |
| `main.py` | Python | Dev server using `http.server` with MIME type override |
| `pyproject.toml` | Config | Python package metadata for uv package manager |
| `.gitignore` | Config | Excludes `__pycache__/`, `/calculator/target/`, `/www/pkg/` |

---

## WASM API Reference

All 8 functions are implemented in `calculator/src/lib.rs` with the `#[wasm_bindgen]` macro, making them callable from JavaScript.

### Function Signatures

| Function | Parameters | Returns | Error Condition | Notes |
|----------|-----------|---------|-----------------|-------|
| `add(a, b)` | `f64`, `f64` | `f64` | None | Always succeeds |
| `subtract(a, b)` | `f64`, `f64` | `f64` | None | Always succeeds |
| `multiply(a, b)` | `f64`, `f64` | `f64` | None | Always succeeds |
| `divide(a, b)` | `f64`, `f64` | `f64` | `b == 0` → `NaN` | Division by zero returns `f64::NAN` |
| `sqrt_a(a)` | `f64` | `f64` | `a < 0` → `NaN` | Square root of negative returns `f64::NAN` |
| `power(a, b)` | `f64`, `f64` | `f64` | None | a^b using `a.powf(b)` |
| `percentage(a, b)` | `f64`, `f64` | `f64` | None | Returns `a * b / 100` |
| `modulo(a, b)` | `f64`, `f64` | `f64` | `b == 0` → `NaN` | Modulo operation; `b == 0` returns `f64::NAN` |

### All functions return `f64` (64-bit floating-point)

JavaScript receives the result as a number and must check for `NaN` to display "Error" (see **Error Handling** below).

---

## UI Operations

The calculator has **8 operations** split into two rows:

### Basic Row (always visible)
| Symbol | Function | Behavior |
|--------|----------|----------|
| `+` | add(A, B) | Adds two numbers; always succeeds |
| `−` | subtract(A, B) | Subtracts B from A |
| `×` | multiply(A, B) | Multiplies two numbers |
| `÷` | divide(A, B) | Divides A by B; returns "Error" if B = 0 |

### Advanced Row (smaller buttons)
| Symbol | Function | Behavior |
|--------|----------|----------|
| `√A` | sqrt_a(A) | Square root of A; ignores B, returns "Error" if A < 0 |
| `A^B` | power(A, B) | A raised to power B |
| `A%B` | percentage(A, B) | Returns A × B ÷ 100 |
| `A mod B` | modulo(A, B) | A modulo B; returns "Error" if B = 0 |

**Number B availability:**
- Operations requiring B: `add`, `subtract`, `multiply`, `divide`, `power`, `percentage`, `modulo`
  - Number B input: **enabled** (opacity: 1.0)
- Operations not requiring B: `sqrt_a`
  - Number B input: **disabled** (opacity: 0.35, pointer-events: none)

---

## Result Formatting

Results are formatted using **IEEE 754 precision handling**:

```javascript
function formatResult(value) {
    if (!Number.isFinite(value)) {
        return 'Error';
    }
    const formatted = parseFloat(value.toPrecision(10)).toString();
    return formatted;
}
```

**Logic:**
1. **Check for non-finite**: If `NaN` or `Infinity`, return `"Error"`
2. **Precision(10)**: Limit to 10 significant digits (e.g., `1.23456789` stays, `1.234567890123` becomes `1.234567890`)
3. **parseFloat()**: Remove trailing zeros introduced by `toPrecision()`
4. **toString()**: Convert back to string for display

**Examples:**
- `1.23456789012` → `"1.234567890"` → displays `1.23456789`
- `0.000123456` → `"0.000123456"` → displays `0.000123456`
- `123456789` → `"123456789"` → displays `123456789`
- `NaN` → displays `"Error"` in red

---

## Error Handling

The calculator uses a **NaN contract** for error conditions:

### Operations that return `NaN`

| Operation | Condition | Rust Code | JS Display |
|-----------|-----------|-----------|------------|
| `divide(a, b)` | `b == 0.0` | `if b == 0.0 { f64::NAN } else { a / b }` | `"Error"` |
| `sqrt_a(a)` | `a < 0.0` | `if a < 0.0 { f64::NAN } else { a.sqrt() }` | `"Error"` |
| `modulo(a, b)` | `b == 0.0` | `if b == 0.0 { f64::NAN } else { a % b }` | `"Error"` |

### Operations that never error

- `add`, `subtract`, `multiply`, `power`, `percentage` — always return a valid `f64`

### JavaScript Error Handling

In `www/index.js`, the `formatResult()` function checks:

```javascript
if (!Number.isFinite(value)) {
    return 'Error';
}
```

When "Error" is displayed:
- **Text**: `"Error"` in the result panel
- **Color**: Red (`#e05b5b`) via `.result-value.error` CSS class

---

## Test Cases

### Basic Operations (Always Succeed)

| Operation | A | B | Expected | Actual | Status |
|-----------|---|---|----------|--------|--------|
| 5 + 3 | 5 | 3 | 8 | 8 | ✓ |
| 10 − 4 | 10 | 4 | 6 | 6 | ✓ |
| 6 × 7 | 6 | 7 | 42 | 42 | ✓ |
| 2 ^ 3 | 2 | 3 | 8 | 8 | ✓ |
| 20 % 5 | 20 | 5 | 1 | 1 | ✓ |
| √16 | 16 | (ignored) | 4 | 4 | ✓ |

### Division Operations

| Operation | A | B | Expected | Actual | Status |
|-----------|---|---|----------|--------|--------|
| 10 ÷ 2 | 10 | 2 | 5 | 5 | ✓ |
| 7 ÷ 0 | 7 | 0 | Error | Error (NaN) | ✓ |

### Modulo Operations

| Operation | A | B | Expected | Actual | Status |
|-----------|---|---|----------|--------|--------|
| 17 mod 5 | 17 | 5 | 2 | 2 | ✓ |
| 17 mod 0 | 17 | 0 | Error | Error (NaN) | ✓ |

### Square Root Operations

| Operation | A | Expected | Actual | Status |
|----------|---|----------|--------|--------|
| √25 | 25 | 5 | 5 | ✓ |
| √0 | 0 | 0 | 0 | ✓ |
| √-4 | -4 | Error | Error (NaN) | ✓ |

### Precision & Formatting

| Operation | A | B | Raw Result | Formatted | Status |
|-----------|---|---|------------|-----------|--------|
| 1 ÷ 3 | 1 | 3 | 0.333... | 0.333333333 | ✓ |
| 0.1 + 0.2 | 0.1 | 0.2 | 0.30000... | 0.3 | ✓ |
| 1000000 × 1000000 | 1000000 | 1000000 | 1e12 | 1000000000000 | ✓ |

---

## Rebuilding

### When to Rebuild

Run `bash build.sh` after:

1. **Modifying `calculator/src/lib.rs`**
   - Adding new functions
   - Changing logic in existing functions
   - Changing return types

2. **Updating `calculator/Cargo.toml`**
   - Adding new dependencies
   - Changing dependency versions

3. **Not required after:**
   - Changes to `www/index.html`, `www/style.css`, `www/index.js` (frontend-only)
   - Restarting the server (main.py)
   - Browser refresh

### Rebuild Workflow

```bash
# 1. Edit calculator/src/lib.rs
# 2. Build
bash build.sh

# 3. Server will automatically pick up new files (www/pkg/)
# 4. Refresh browser (Ctrl+Shift+R for hard refresh to clear cache)
```

**Note:** If the server is running when you rebuild, the new WASM files are immediately available at `www/pkg/`. Just refresh the browser to load the updated module.

---

## .gitignore Notes

The `.gitignore` file excludes:

```
# Python-generated files
__pycache__/
*.pyc
*.pyo
build/
dist/
wheels/
*.egg-info

# Virtual environments
.venv

# Rust build artifacts
/calculator/target/

# WASM output
/www/pkg/
```

### Why These Are Excluded

- **`/calculator/target/`** — Rust build intermediate files; regenerated by `cargo` / `wasm-pack`
- **`/www/pkg/`** — WASM output (`.wasm`, `.js`, `.d.ts`); regenerated by `bash build.sh`
  - These are build artifacts, not source code
  - Each developer rebuilds them locally
  - Reduces repository size significantly

### What IS Checked In

- ✓ `calculator/src/lib.rs` — Source code
- ✓ `calculator/Cargo.toml` — Rust dependencies
- ✓ `www/index.html`, `www/style.css`, `www/index.js` — Frontend source
- ✓ `build.sh`, `main.py` — Build & server scripts
- ✓ `CLAUDE.md`, `README.md` — Documentation

---

## Quick Start (One-Liner for New Developers)

Assuming Rust, wasm-pack, Python 3.12+, and Node v24+ are installed:

```bash
bash build.sh && python main.py
```

Then open http://localhost:8000/ in your browser.

To create a public URL:

```bash
./cloudflared tunnel --url http://localhost:8000
```

---

## Troubleshooting

### Server runs but UI shows "Loading..." or "Error loading WASM"

**Check:**
1. Browser console (F12 → Console tab) for error messages
2. Network tab (F12 → Network) — verify `calculator.js` and `calculator_bg.wasm` are loading (status 200)
3. WASM MIME type: verify `main.py` line 14 sets `Handler.extensions_map[".wasm"] = "application/wasm"`

**Fix:**
- Restart Python server: Ctrl+C, then `python main.py`
- Hard refresh browser: Ctrl+Shift+R (bypasses cache)

### "Port 8000 already in use"

```bash
# Find what's using port 8000
lsof -i :8000

# Kill the process
kill -9 <PID>

# Retry
python main.py
```

### Changes to Rust code not reflected in calculator

You must rebuild the WASM module:

```bash
bash build.sh
```

Then hard-refresh the browser (Ctrl+Shift+R) to clear the cached `.wasm` file.

### "cloudflared: command not found"

The binary is included in the repo at `./cloudflared`. If missing or corrupted:

```bash
# Re-download Cloudflare Tunnel binary
curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
chmod +x cloudflared
./cloudflared tunnel --url http://localhost:8000
```

---

## Summary

1. **Install tools** (Step 0) — Rust, wasm-pack, Python 3.12+, Node v24+
2. **Build WASM** (Step 1) — `bash build.sh` → compiles Rust to WebAssembly
3. **Serve locally** (Step 2) — `python main.py` → http://localhost:8000/
4. **Go public** (Step 3) — `./cloudflared tunnel --url http://localhost:8000` → public URL
5. **Edit & rebuild** — Modify `calculator/src/lib.rs`, run `bash build.sh`, refresh browser

The calculator supports **8 operations** with live result formatting, error handling for division/sqrt/modulo, and a clean, responsive UI built with modern web standards.
